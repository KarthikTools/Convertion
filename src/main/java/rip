// Postman test script to write response to CSV
const writeResponseToCSV = (responseData) => {
    try {
        // Parse the response data if it's a string
        const data = typeof responseData === 'string' ? JSON.parse(responseData) : responseData;
        
        // Get current timestamp for filename
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `postman_response_${timestamp}.csv`;
        
        // Convert data to CSV format
        let csvContent = '';
        
        // Handle both array and single object responses
        const items = Array.isArray(data) ? data : [data];
        
        if (items.length > 0) {
            // Get headers from first item
            const headers = Object.keys(items[0]);
            csvContent += headers.join(',') + '\n';
            
            // Add data rows
            items.forEach(item => {
                const row = headers.map(header => {
                    const value = item[header];
                    // Handle special characters and wrap in quotes if needed
                    return typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n')) 
                        ? `"${value.replace(/"/g, '""')}"` 
                        : value;
                });
                csvContent += row.join(',') + '\n';
            });
        }
        
        // Save the file
        const file = new File([csvContent], filename, { type: 'text/csv' });
        const blob = new Blob([csvContent], { type: 'text/csv' });
        
        // Create download link
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        
        console.log(`CSV file saved as: ${filename}`);
        return true;
    } catch (error) {
        console.error('Error writing to CSV:', error);
        return false;
    }
};

// Example usage in Postman test script
pm.test("Write response to CSV", function () {
    const response = pm.response.json();
    const success = writeResponseToCSV(response);
    pm.expect(success).to.be.true;
}); 
